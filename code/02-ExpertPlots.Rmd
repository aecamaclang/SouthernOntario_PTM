---
title: "Summary Plots"
author: "Abbey Camaclang"
date: "`r Sys.Date()`"
output: html_document
---

Creates plots of initial estimates for expert review and revision.  

This script creates two plots for each Ecological Group:

1) boxplots of the best guess, lowest, and highest estimates for each Strategy from all Experts;  
2) pointrange plots showing the best guess, lowest, and highest estimates of each Expert for each Strategy.  
It requires a table of all individual expert estimates (**Estimates_tidy.csv**).  

It also creates a pointrange plot of the aggregated (mean) best guess, lowest, and highest estimates, given a table of mean estimates (**Estimates_avg_persistence.csv**) or feasibility-weighted mean estimates.   (**Expected_Performance.csv**).

NOTE that plots showing individual expert estimates have been excluded from the archived version.

```{r plotsetup, message = FALSE}
library(tidyverse)
library(cowplot)
library(gridExtra)
library(here)

# Specify paths to subfolders within current working (R project) directory
derived <- here("data") 
results <- here("results") 
figures <- here("figures") # where plots will be saved
explots <- here("figures/expertplots") # where individual files for expert review will be saved 

# Read in data
long <- read_csv(paste(derived,"/Estimates_tidy.csv", sep=""))

strat.levels <- unique(long$Strategy)
grp.levels <- unique(long$Ecological.Group)
expcode <- unique(long$Expert) 
est.levels <- c("Low", "Best", "High")

long$Strategy <- factor(long$Strategy, levels = strat.levels)
long$Estimate <- factor(long$Estimate, levels = est.levels)

long <- na.omit(long) 

# Rearrange table so estimates for each ecol group-strategy are on the same row
wide <- spread(long, key = Estimate, value = Value)
wide$Expert <- as.factor(wide$Expert)

```

### Boxplots of all estimates

```{r boxplots, eval = FALSE}

for (j in seq_along(expcode)) {
  
  # If you do NOT need to highlight each expert's response, comment out the relevant lines (indicated below) and run the inside loop (below) only to get a single file
  grp.list <- list()
  
  for (i in seq_along(grp.levels)) { 
    
    temp.grpdata <- subset(long, Ecological.Group == grp.levels[i])
    
    temp.plot <-
      ggplot(temp.grpdata, aes(x = Estimate, 
                               y = Value, 
                               fill = Estimate) 
             ) + 
      geom_boxplot(width=0.4) + 
      geom_point(data = subset(temp.grpdata, Expert == expcode[j]), # plot expert [j]'s estimates as blue points
                 aes(x = Estimate, y = Value),
                 color = 'blue'
                 ) + # include the geom_point option only if you want to highlight individual expert responses
      theme_cowplot() +   
      theme(plot.margin = unit(c(1.5, 1, 1.5, 1), "cm"), 
            panel.spacing = unit(1, "lines"), 
            axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), 
            plot.caption = element_text(size = 10, hjust = 0)
            ) + 
      facet_wrap( ~ Strategy, nrow = 3) +  # one panel per management strategy
      scale_x_discrete(name = "",
                       breaks = c("Low", "Best", "High"),
                       labels = c("L", "B", "H") # Give the x-axis variables shortened labels
                       ) + 
      scale_fill_manual(values = c("white", "gray80", "white"), 
                        guide = "none" # remove legend
                        ) + 
      labs(x = "", 
           y = "Probability of persistence (%)", 
           title = paste(grp.levels[i]),
           caption = str_wrap(paste0(
             "Figure ", i, ". Boxplots summarizing the distribution of the lowest (L), best guess (B), and highest (H) expert estimates of the probability of persistence of ", grp.levels[i], " under the Baseline scenario and each of the management strategies (S1 - S15). The thick horizontal lines indicate the median estimate, while the surrounding box shows the interquartile range. Any outliers are shown as points beyond the plot whiskers. Your individual estimates are shown in blue."), 150)
           ) +
      ylim(0, 100)
    
    grp.list[[i]] <- temp.plot
    
  }
  
  # Save all plots as a single .pdf: 
  plot1 <- marrangeGrob(grp.list, nrow = 1, ncol = 1, top = NULL) # one plot (species group) per page
  ggsave(
    # filename = "All_boxplot.pdf", # use instead if generating a single file with no highlighting
    filename = paste0("exp", expcode[j], "_boxplot.pdf", sep=''),
    plot1, 
    path = explots, 
    width = 11, height = 8.5, units = "in")
  
}
```

### Pointrange plots of individual estimates

```{r pointrange, eval = FALSE}
for (j in seq_along(expcode)) {
  
  # If you do NOT need to highlight each individual response, comment out the relevant lines (indicated below) and run the inside loop (below) only to get a single file
  grp.list <- list()
  
  for (i in seq_along(grp.levels)) {
    
    temp.expdata <- subset(wide, Ecological.Group == grp.levels[i])
    temp.expdata <- mutate(temp.expdata, expi = ifelse(Expert == expcode[j], T, F)) # use if highlighting individual expert responses
    
    temp.plot2 <-
      ggplot(temp.expdata, aes(x = Expert, 
                               y = Best 
                               , color = expi, # use this only if highlighting individual expert responses
                               )
             ) +  
      geom_pointrange(aes(ymin = Low, ymax = High)) +
      theme_cowplot() +  
      theme(plot.margin = unit(c(1.5, 1, 1.5, 1), "cm"), 
            panel.spacing = unit(1, "lines"), 
            axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), 
            axis.text.x = element_text(size=10),
            # axis.text.x = element_blank(), # use this instead to remove x-axis labels of expert code (for archiving)
            plot.caption = element_text(size = 10, hjust = 0)
            ) +  
      scale_color_manual(values = c("grey", "blue"), guide = "none") + # needed if highlighting individual expert responses
      facet_wrap( ~ Strategy, nrow = 3) +  # one panel per management strategy
      labs(x = "Experts",
           y = "Probability of persistence (%)",
           title = paste(grp.levels[i]),
           caption = str_wrap(paste0(
             "Figure ", i, ". Plots of each expert estimate of the probability of persistence of ", grp.levels[i], 
             " under the Baseline scenario and each of the management strategies (S1 - S15). Each point indicates 
             the best guess of one expert. Your individual estimates are plotted in blue."), 150)
           ) +
      ylim(0, 100) 
    
    grp.list[[i]] <- temp.plot2
  }
  
  # Save all plots as a single .pdf: 
  plot2 <- marrangeGrob(grp.list, nrow = 1, ncol = 1, top = NULL) # one plot per page
  ggsave(
    # filename = "All_pointrange.pdf", # use instead if plotting all estimates without highlighting
    filename = paste0("exp", expcode[j], "_pointrange.pdf", sep=''), # if highlighting individual expert estimates
    plot2, 
    path = explots,
    width = 11, height = 8.5, units = "in"
  )
  
}
```

### Pointrange plots of the aggregated estimates  

It can be used to plot mean estimates of probability of persistence (using **Estimates_avg_persistence.csv**) or mean estimates weighted by feasibility (using **Expected_Performance.csv**).  

For the review/revision stage of expert elicitation, use plots of the unweighted mean estimates.

```{r avgplots, message = FALSE}
# Specify which estimates will be used
weighted <- 0 # (1) if values are weighted by feasibility, (0) if not

# Read in correct probability of persistence data
if (weighted == 0) {
  est.file <- "/Estimates_avg_persistence" # unweighted
} else {
  if (weighted == 1) {
    est.file <- "/ExpPerform_all" # feasibility weighted
  } else {
    stop("Must specify if estimates are weighted by feasibility (1) or not (0)")
  }
}
persistence <- read_csv(paste0(results, est.file, ".csv"))

grp.levels <- unique(persistence$Ecological.Group)
persistence$Ecological.Group <- factor(persistence$Ecological.Group, levels = grp.levels)

# Organize data into correct format for plotting
persistence.long <- persistence %>%
  gather(., key = "Estimate", value = "Value", -Ecological.Group) %>%
  separate(., Estimate, c("Est.Type", "Strategy"), sep = "[_]", remove = TRUE) %>%
  mutate(Strategy = factor(Strategy, levels = unique(Strategy)))

plot.data <- persistence.long %>%
  spread(., 
         key = Est.Type, 
         value = Value)

strat.levels <- levels(plot.data$Strategy)

write_csv(plot.data, paste0(results, est.file, "_tidy.csv"))

baseline.data <- plot.data[which(plot.data$Strategy=="Baseline"),]
strategy.data <- plot.data[which(plot.data$Strategy!="Baseline"),]

# Create plot
temp.plot3 <- 
  ggplot(strategy.data, aes(x = Strategy, y = Wt.Best) ) +
  geom_pointrange(aes(ymin = Wt.Low, ymax = Wt.High)) +
  geom_hline(aes(yintercept = Wt.Best), baseline.data, colour = "blue") +
  geom_hline(aes(yintercept = Wt.Low), baseline.data, colour = "blue", lty = "dashed") +
  geom_hline(aes(yintercept = Wt.High), baseline.data, colour = "blue", lty = "dashed") +
  theme_cowplot() +  
  theme(plot.margin = unit(c(1.5, 1, 1.5, 1), "cm"), # t, r, b and l margins around the plot area
        panel.spacing = unit(1, "lines"), # adjust margins and between panels of the plot 
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), 
        axis.text.x = element_text(size = 8, angle = 65, hjust = 1, vjust = 1)
        , plot.caption = element_text(size =10, hjust = 0)
        ) +
  facet_wrap( ~ Ecological.Group, nrow = 4, ncol = 4) +  # one panel per ecological group
  theme(strip.text = element_text(size=8))+
  labs(x = "Strategies",
       y = "Probability of persistence (%)"
       , caption = str_wrap("Estimated probability of persistence of each ecological group under each of the management strategies (Best Guess = solid black dots, Lowest and- Highest estimates = black vertical lines), compared to the probability under the Baseline scenario (blue horizontal lines: Best Guess = solid lines, Lowest and Highest Estimates = dashed lines). Values are based on expert estimates averaged over the number of experts that provided estimates for the strategy and ecological group.", 100)
       ) +  
  ylim(0, 100) 

# Save as .pdf for expert review
ggsave(filename=paste0(explots, est.file, "_plot.pdf"), 
       temp.plot3, 
       width = 8.5, height = 11, 
       units = "in")

# Save plot of unweighted mean estimates as .png for use as Fig. B-2 of manuscript
if (weighted == 0) {
  temp.plot3 <- temp.plot3 + labs(caption = "")
  ggsave(filename=paste0(figures, "/FigureB-2.png"),
         temp.plot3,
         width = 7.5, height = 10, units = "in")
}
```


